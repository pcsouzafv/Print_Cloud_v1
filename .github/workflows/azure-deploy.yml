name: Deploy to Azure

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: rg-printcloud-prod
  AZURE_CONTAINER_APP: printcloud-app-prod
  AZURE_CONTAINER_REGISTRY: printcloudregistry1756467509
  AZURE_REGISTRY_URL: printcloudregistry1756467509.azurecr.io
  IMAGE_NAME: printcloud

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    name: ğŸ”¨ Build and Test
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ”§ Install dependencies
      run: npm ci

    - name: ğŸ¯ Generate Prisma client
      run: npx prisma generate

    - name: ğŸ” Run linter
      run: npm run lint

    - name: ğŸ”§ Type check
      run: npm run typecheck

    - name: ğŸ—ï¸ Build application
      run: npm run build

    - name: ğŸ“Š Build summary
      run: |
        echo "âœ… Build completed successfully"
        echo "ğŸ“¦ Next.js build size:"
        du -sh .next/ || echo "Build size not available"

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy to Azure
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”‘ Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ğŸ—ï¸ Build Docker image
      run: |
        docker build . -t ${{ env.AZURE_REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        docker build . -t ${{ env.AZURE_REGISTRY_URL }}/${{ env.IMAGE_NAME }}:latest

    - name: ğŸ“¦ Push to Azure Container Registry
      run: |
        az acr login --name ${{ env.AZURE_CONTAINER_REGISTRY }}
        docker push ${{ env.AZURE_REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        docker push ${{ env.AZURE_REGISTRY_URL }}/${{ env.IMAGE_NAME }}:latest

    - name: ğŸš€ Deploy to Azure Container Apps
      run: |
        az containerapp update \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_CONTAINER_APP }} \
          --image ${{ env.AZURE_REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

    - name: â³ Wait for deployment
      run: sleep 60

    - name: ğŸ—„ï¸ Run database migrations
      run: |
        echo "ğŸ”„ Running database migrations..."
        az containerapp exec \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_CONTAINER_APP }} \
          --command "npx prisma migrate deploy" || echo "âš ï¸  Migration failed - check manually"

    - name: ğŸ¥ Health check
      run: |
        WEBAPP_URL=$(az containerapp show \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_CONTAINER_APP }} \
          --query properties.configuration.ingress.fqdn \
          --output tsv)
        
        echo "ğŸŒ Application URL: https://$WEBAPP_URL"
        
        # Wait for app to be ready
        sleep 30
        
        # Check health endpoint
        for i in {1..5}; do
          if curl -f -s "https://$WEBAPP_URL/api/health" > /dev/null; then
            echo "âœ… Health check passed"
            break
          else
            echo "â³ Waiting for app to be ready (attempt $i/5)..."
            sleep 10
          fi
        done

    - name: ğŸ“Š Deployment summary
      run: |
        WEBAPP_URL=$(az containerapp show \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_CONTAINER_APP }} \
          --query properties.configuration.ingress.fqdn \
          --output tsv)
        
        echo "## ğŸ‰ Deploy Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸŒ Application URL | https://$WEBAPP_URL |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ“¦ Image Tag | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ·ï¸ Git Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ‘¤ Deployed by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ• Deploy Time | $(date -u) |" >> $GITHUB_STEP_SUMMARY
        
        echo "âœ… Deployment completed successfully!"
        echo "ğŸŒ Access your application at: https://$WEBAPP_URL"

  notify:
    needs: [build-and-test, deploy]
    runs-on: ubuntu-latest
    name: ğŸ“¢ Notify
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¢ Deployment notification
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… Print Cloud deployed successfully to Azure!"
        else
          echo "âŒ Print Cloud deployment failed!"
        fi