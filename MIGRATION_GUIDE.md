# üöÄ Guia Completo de Migra√ß√£o - Print Cloud

## üìã Vis√£o Geral

Este guia detalha como migrar completamente o projeto Print Cloud para uma nova conta Microsoft/Azure, incluindo todos os recursos, configura√ß√µes e scripts automatizados necess√°rios.

O processo de migra√ß√£o √© totalmente automatizado atrav√©s de scripts PowerShell que criam uma nova inst√¢ncia completamente independente da aplica√ß√£o Print Cloud em qualquer conta Azure.

## üèóÔ∏è Arquitetura da Aplica√ß√£o

### Tecnologias Utilizadas
- **Frontend**: Next.js 14 com TypeScript
- **Autentica√ß√£o**: Microsoft Authentication Library (MSAL) + Azure AD
- **Base de Dados**: PostgreSQL (Azure Database for PostgreSQL)
- **Hospedagem**: Azure Container Apps
- **Registro de Containers**: Azure Container Registry (ACR)
- **ORM**: Prisma
- **Containeriza√ß√£o**: Docker
- **IA e An√°lise**: Azure OpenAI Service + Azure Text Analytics

### Recursos Azure Criados
- **Resource Group**: `rg-printcloud-prod`
- **Container Apps Environment**: `printcloud-env-prod`
- **Container App**: `printcloud-app-prod`
- **Container Registry**: `printcloudregistry`
- **PostgreSQL Database**: `printcloud-db-prod`
- **Azure AD App Registration**: `Print Cloud Production`
- **Azure OpenAI Service**: Servi√ßos de IA conversacional
- **Azure Text Analytics**: An√°lise de sentimento e padr√µes

### Configura√ß√µes da Inst√¢ncia Atual
- **Location**: Brazil South
- **Subscription**: Assinatura do Azure 1
- **Tenant**: vtr1m.onmicrosoft.com
- **Client ID**: f37521b3-eff4-4c2e-94ac-470c858cde33
- **Tenant ID**: eac6c00d-e01e-40f8-bb5f-bac6b0ced795

## üìÇ Estrutura de Arquivos

```
Print_Cloud_v1/
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ migration/
‚îÇ       ‚îú‚îÄ‚îÄ 01_prereqs_check.ps1         # Verifica√ß√£o de pr√©-requisitos
‚îÇ       ‚îú‚îÄ‚îÄ 02_configure_azure_ad.ps1    # Configura√ß√£o Azure AD
‚îÇ       ‚îú‚îÄ‚îÄ 03_deploy_infrastructure.ps1 # Deploy da infraestrutura
‚îÇ       ‚îú‚îÄ‚îÄ 04_update_redirect_uris.ps1  # Atualiza√ß√£o redirect URIs
‚îÇ       ‚îú‚îÄ‚îÄ 05_run_migrations.ps1        # Migra√ß√µes do banco
‚îÇ       ‚îî‚îÄ‚îÄ migrate_complete.ps1         # Script completo autom√°tico
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app/                             # Aplica√ß√£o Next.js
‚îÇ   ‚îú‚îÄ‚îÄ components/                      # Componentes React
‚îÇ   ‚îú‚îÄ‚îÄ lib/                            # Bibliotecas e utilit√°rios
‚îÇ   ‚îú‚îÄ‚îÄ providers/                      # Providers (MSAL, etc.)
‚îÇ   ‚îî‚îÄ‚îÄ types/                          # Defini√ß√µes TypeScript
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îú‚îÄ‚îÄ schema.prisma                   # Schema da base de dados
‚îÇ   ‚îî‚îÄ‚îÄ seed.ts                         # Dados iniciais
‚îú‚îÄ‚îÄ Dockerfile                          # Container da aplica√ß√£o
‚îú‚îÄ‚îÄ docker-compose.yml                  # Desenvolvimento local
‚îú‚îÄ‚îÄ package.json                        # Depend√™ncias Node.js
‚îú‚îÄ‚îÄ .env.example                        # Exemplo vari√°veis ambiente
‚îú‚îÄ‚îÄ .env.local                          # Configura√ß√£o desenvolvimento
‚îî‚îÄ‚îÄ azure_ad_config.json               # Configura√ß√£o gerada (ap√≥s migra√ß√£o)
```

## üîÑ Processo de Migra√ß√£o Completo

### Op√ß√£o 1: Migra√ß√£o Autom√°tica (Recomendada)

Execute o script principal que automatiza todo o processo:

```powershell
# Na pasta do projeto
.\scripts\migration\migrate_complete.ps1
```

O script ir√° executar automaticamente todas as 5 fases da migra√ß√£o.

### Op√ß√£o 2: Migra√ß√£o Manual (Passo a Passo)

#### Fase 1: Verifica√ß√£o de Pr√©-requisitos

```powershell
.\scripts\migration\01_prereqs_check.ps1
```

**Verifica:**
- Azure CLI instalado e funcional
- Docker instalado e executando
- Node.js instalado
- Git instalado
- Login no Azure CLI realizado
- Provedores Azure necess√°rios

#### Fase 2: Configura√ß√£o Azure AD

```powershell
.\scripts\migration\02_configure_azure_ad.ps1
```

**Executa:**
- Cria App Registration no Azure AD
- Configura permiss√µes Microsoft Graph
- Define redirect URIs tempor√°rios
- Gera configura√ß√£o inicial
- Salva credenciais no arquivo `azure_ad_config.json`

#### Fase 3: Deploy da Infraestrutura

```powershell
.\scripts\migration\03_deploy_infrastructure.ps1
```

**Cria:**
- Resource Group
- Container Registry (ACR)
- PostgreSQL Database
- Container Apps Environment
- Build e push da imagem Docker
- Deploy da aplica√ß√£o Container App
- Configura√ß√£o de rede e DNS

#### Fase 4: Atualiza√ß√£o de Redirect URIs

```powershell
.\scripts\migration\04_update_redirect_uris.ps1
```

**Atualiza:**
- Redirect URIs no Azure AD
- Inclui URL da aplica√ß√£o produzida
- Mant√©m URLs de desenvolvimento local

#### Fase 5: Migra√ß√µes da Base de Dados

```powershell
.\scripts\migration\05_run_migrations.ps1
```

**Executa:**
- Instala√ß√£o de depend√™ncias
- Gera√ß√£o do cliente Prisma
- Sincroniza√ß√£o do schema da base de dados
- Execu√ß√£o de seeds (dados iniciais)
- Teste de conectividade

## üõ†Ô∏è Pr√©-requisitos

### Ferramentas Necess√°rias
- **Azure CLI** v2.50+ - [Instalar](https://aka.ms/InstallAzureCli)
- **Docker Desktop** - [Instalar](https://docs.docker.com/desktop/install/windows-install/)
- **Node.js** v18+ - [Instalar](https://nodejs.org/)
- **Git** - [Instalar](https://git-scm.com/download/win)
- **PowerShell** 5.1+ (inclu√≠do no Windows)

### Permiss√µes Azure Necess√°rias
- **Contributor** na subscription Azure
- **Application Administrator** no Azure AD
- Permiss√£o para criar recursos na subscription

### Configura√ß√£o Inicial
```powershell
# 1. Login no Azure
az login

# 2. Verificar subscription ativa
az account show

# 3. Configurar subscription (se necess√°rio)
az account set --subscription "SUA_SUBSCRIPTION_ID"
```

## ‚öôÔ∏è Configura√ß√µes Personalizadas

### Par√¢metros do Script Principal

```powershell
.\scripts\migration\migrate_complete.ps1 `
    -AppName "Meu Print Cloud" `
    -ResourceGroup "rg-meuapp-prod" `
    -Location "East US" `
    -ConfigFile "minha_config.json"
```

### Par√¢metros Dispon√≠veis
- **AppName**: Nome da aplica√ß√£o Azure AD (padr√£o: "Print Cloud Production")
- **ResourceGroup**: Nome do resource group (padr√£o: "rg-printcloud-prod")
- **Location**: Localiza√ß√£o Azure (padr√£o: "Brazil South")
- **ConfigFile**: Arquivo de configura√ß√£o (padr√£o: "azure_ad_config.json")
- **SkipPrereqs**: Pula verifica√ß√£o de pr√©-requisitos
- **Verbose**: Output detalhado

### ü§ñ Configura√ß√£o dos Servi√ßos de IA (Opcional)

Para funcionalidade completa de IA, configure as vari√°veis de ambiente antes do deploy:

```powershell
# Configura√ß√£o Azure OpenAI
$env:AZURE_OPENAI_ENDPOINT = "https://seu-openai.openai.azure.com/"
$env:AZURE_OPENAI_API_KEY = "sua-api-key"
$env:AZURE_OPENAI_DEPLOYMENT_NAME = "gpt-35-turbo"

# Configura√ß√£o Text Analytics
$env:AZURE_TEXT_ANALYTICS_ENDPOINT = "https://seu-text-analytics.cognitiveservices.azure.com/"
$env:AZURE_TEXT_ANALYTICS_API_KEY = "sua-api-key"

# Executar deploy com IA
.\scripts\migration\migrate_complete.ps1
```

**Nota**: Se n√£o configurados, a aplica√ß√£o funcionar√° com dados simulados de IA.

## üìä Monitoramento da Migra√ß√£o

### Durante a Execu√ß√£o
Os scripts fornecem output colorido indicando:
- ‚úÖ **Verde**: Sucesso
- ‚ùå **Vermelho**: Erro
- ‚ö†Ô∏è **Amarelo**: Aviso
- üîÑ **Azul**: Em progresso

### Arquivo de Configura√ß√£o Gerado
O arquivo `azure_ad_config.json` cont√©m:
```json
{
  "AzureAD": {
    "ClientId": "uuid-gerado",
    "TenantId": "uuid-do-tenant",
    "ObjectId": "uuid-do-objeto",
    "AppName": "Nome da Aplica√ß√£o"
  },
  "Deployment": {
    "Infrastructure": {
      "ResourceGroup": "nome-do-rg",
      "Application": {
        "URL": "https://sua-app.azurecontainerapps.io"
      },
      "Database": {
        "Server": "servidor.postgres.database.azure.com",
        "ConnectionString": "string-de-conexao"
      }
    }
  }
}
```

## üîí Considera√ß√µes de Seguran√ßa

### Credenciais Importantes
‚ö†Ô∏è **ATEN√á√ÉO**: As seguintes informa√ß√µes s√£o cr√≠ticas e devem ser guardadas com seguran√ßa:

1. **Password da Base de Dados**: Gerada automaticamente durante o deploy
2. **Connection String**: Cont√©m credenciais de acesso √† base de dados
3. **Client ID e Tenant ID**: Necess√°rios para autentica√ß√£o
4. **Arquivo de Configura√ß√£o**: Cont√©m informa√ß√µes sens√≠veis

### Boas Pr√°ticas
- Mantenha o arquivo `azure_ad_config.json` seguro e com backup
- N√£o commite credenciais no controle de vers√£o
- Use Azure Key Vault para produ√ß√£o (opcional)
- Implemente rota√ß√£o de passwords regulares

## üö® Resolu√ß√£o de Problemas

### Problemas Comuns

#### 1. Erro de Login Azure
```
Error: Please run 'az login' to setup account.
```
**Solu√ß√£o**: Execute `az login` e tente novamente

#### 2. Permiss√µes Insuficientes
```
Error: Insufficient privileges to complete the operation.
```
**Solu√ß√£o**: Verifique se tem permiss√µes de Contributor na subscription

#### 3. Nome do Registry J√° Existe
```
Error: The registry name 'printcloudregistry' is not available.
```
**Solu√ß√£o**: Use um nome diferente com o par√¢metro `-RegistryName`

#### 4. Falha na Build Docker
```
Error: Failed to build container image
```
**Solu√ß√£o**: Verifique se o Dockerfile est√° correto e as depend√™ncias est√£o instaladas

### Logs Detalhados
Para debugging, execute com verbose:
```powershell
.\scripts\migration\migrate_complete.ps1 -Verbose
```

## ‚úÖ Valida√ß√£o P√≥s-Migra√ß√£o

### Checklist de Verifica√ß√£o
- [ ] Aplica√ß√£o acess√≠vel na URL fornecida
- [ ] Login Azure AD funcional
- [ ] Base de dados conectada e funcional
- [ ] Todas as funcionalidades testadas
- [ ] Configura√ß√£o salva e com backup

### Testes Funcionais
1. **Acesso √† Aplica√ß√£o**: Abrir URL da aplica√ß√£o
2. **Autentica√ß√£o**: Login com conta Azure AD
3. **Funcionalidades**: Testar recursos principais
4. **Performance**: Verificar tempos de resposta
5. **Logs**: Verificar logs da aplica√ß√£o no Azure
6. **ü§ñ IA Assistente**: Testar chat e an√°lises inteligentes
7. **üìä Insights**: Verificar recomenda√ß√µes e padr√µes gerados

## üîÑ Migra√ß√£o Reversa

Para reverter ou migrar novamente:
1. Apague o resource group criado: `az group delete --name rg-printcloud-prod`
2. Remova o App Registration do Azure AD
3. Delete o arquivo `azure_ad_config.json`
4. Execute a migra√ß√£o novamente

## üìû Suporte

### Em Caso de Problemas
1. Verifique os logs detalhados dos scripts
2. Consulte a documenta√ß√£o oficial do Azure
3. Verifique permiss√µes e quotas da subscription
4. Entre em contato com o administrador Azure

### Links √öteis
- [Documenta√ß√£o Azure Container Apps](https://docs.microsoft.com/en-us/azure/container-apps/)
- [Azure Database for PostgreSQL](https://docs.microsoft.com/en-us/azure/postgresql/)
- [Azure AD App Registration](https://docs.microsoft.com/en-us/azure/active-directory/develop/)
- [Next.js Documentation](https://nextjs.org/docs)

---

> ‚úÖ **Sucesso**: Com estes scripts e documenta√ß√£o, voc√™ pode migrar o Print Cloud para qualquer conta Azure de forma autom√°tica e confi√°vel.